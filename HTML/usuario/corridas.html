<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corridas Guardadas</title>
  <link rel="stylesheet" href="../estilos.css">
</head>
<body>
  <div class="header">
    <img src="../img/ADO-Autobuses-de-Oriente-Logo-700x394.png" alt="ADO Logo">
    <div class="nav-links">
      <a href="../usuario/inicio.html">Inicio</a>
      <div class="dropdown">
        <a href="#" class="dropbtn">Boletos</a>
        <div class="dropdown-content">
            <a href="../sesion/compra de boleto.html">Comprar boleto</a>
            <a href="../usuario/cambiar-boleto.html">Cambiar boleto</a>
            <a href="../usuario/cancelar-boleto.html">Cancelar boleto</a>
            <a href="../usuario/ver-boleto.html">Ver boleto</a>
        </div>
      </div>
      <a href="../usuario/corridas.html">Corridas</a> 
      <a href="../usuario/perfil.html">Perfil</a>
      <a href="../index.html" class="logout-button">Cerrar Sesión</a>
  </div>
</div>

  <script>
    const token = localStorage.getItem('token');
    const container = document.getElementById("corridasContainer");

    function fetchCorridas() {
      fetch("http://127.0.0.1:8000/api/corrida/view", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ token: token }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.corridas && data.corridas.length > 0) {
          data.corridas.forEach((corrida, index) => {
            const totalAsientos = corrida.asientos.length;
            const disponibles = corrida.asientos.filter(asiento => asiento.estado === "disponible").length;
            const ocupados = totalAsientos - disponibles;
            function formatHour(hour) {
              // Verifica que la hora esté en un formato válido
              if (hour && hour.includes(":")) {
                // Divide la hora en sus componentes
                const [hours, minutes] = hour.split(":").map(part => parseInt(part, 10));
                if (!isNaN(hours) && !isNaN(minutes)) {
                  // Determina si es AM o PM
                  const period = hours >= 12 ? "PM" : "AM";
                  // Convierte las horas al formato de 12 horas
                  const adjustedHours = hours % 12 || 12; // Convierte "0" o "12" a "12" en formato 12 horas
                  return `${adjustedHours}:${minutes.toString().padStart(2, "0")} ${period}`;
                }
              }
              return hour; // Devuelve el valor original si no cumple el formato esperado
            }
            container.innerHTML += `
              <div class="corrida">
                <h2>Detalles de la Corrida</h2>
                <div class="container">
                  <div class="card">
                    <h3>Corrida ${index + 1}</h3>
                    <p><strong>Autobús:</strong> ${corrida.id}</p>
                    <p><strong>Autobús:</strong> ${corrida.id_autobus}</p>
                    <p><strong>Origen:</strong> ${corrida.origen}</p>
                    <p><strong>Destino:</strong> ${corrida.destino}</p>
                    <p><strong>Fecha:</strong> ${corrida.fecha}</p>
                    <p><strong>Hora de salida:</strong>  ${formatHour(corrida.hora_salida)}</p>
                    <p><strong>Hora estimada de llegada:</strong> ${formatHour( corrida.hora_estima_llegada)}</p>
                    <p><strong>Tipo de Corrida:</strong> ${corrida.tipo_corrida}</p>
                    <p><strong>Total Asientos:</strong> ${totalAsientos}</p>
                    <p><strong>Asientos Disponibles:</strong> ${disponibles}</p>
                    <p><strong>Asientos Ocupados:</strong> ${ocupados}</p>
                    <p><strong>Precio:</strong> $${corrida.precio}</p>
                    <button class="btn" onclick="idCorri(${corrida.id})">
                      Comprar boleto
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          container.innerHTML += "<p>No hay corridas disponibles.</p>";
        }
      })
      .catch(error => {
        console.error("Error al obtener las corridas:", error);
        container.innerHTML += "<p>Ocurrió un error al cargar las corridas. Intenta nuevamente más tarde.</p>";
      });
    }

    function idCorri(id) {
      // Guardar los datos de la corrida en localStorage
      localStorage.setItem('idCorrida', id);

      // Redirigir al formulario de compra con los datos
      window.location.href = "../sesion/compra de boleto.html"; 
    }

    // Llamar a la función al cargar la página
    fetchCorridas();
  </script>
</body>
<script src="../apis/sesion.js"></script>
<script src="../apis/logout.js"></script>
<script src="../apis/vistasCorrida.js"></script>
</html>
