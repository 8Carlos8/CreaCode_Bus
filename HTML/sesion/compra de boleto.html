<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Compra</title>
  <link rel="stylesheet" href="../style.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* General Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #FFF;
      color: #333;
    }

    /* Header */
   /* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background-color: #FCF0E3;
}

.header img {
  max-width: 100px;
  margin-right: auto;
  padding: 0px 100px;
}

.nav-links {
  display: flex;
  align-items: center;
  gap: 20px;
}

.nav-links a {
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.nav-links a:hover {
  text-decoration: underline;
}

/* Dropdown Menu para Boletos */
.dropdown {
  position: relative;
}

.dropbtn {
  color: #333;
  font-size: 16px;
  font-weight: bold;
  text-decoration: none;
  cursor: pointer;
  padding: 10px;
}

.dropdown-content {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 5px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  min-width: 200px;
  z-index: 1000;
}

.dropdown-content a {
  display: block;
  padding: 10px 15px;
  color: #333;
  text-decoration: none;
  font-size: 14px;
  transition: background-color 0.3s ease;
}

.dropdown-content a:hover {
  background-color: #f0f0f0;
}

.dropdown:hover .dropdown-content {
  display: block;
}

/* Botón de cerrar sesión */
.logout-button {
  background-color: #f28b82;
  color: #fff;
  padding: 10px 20px;
  border-radius: 5px;
  text-decoration: none;
  display: inline-block;
  cursor: pointer;
  font-size: 16px;
  text-align: center;
}

.logout-button:hover {
  background-color: #e57373;
}



    /* Main Form */
    form {
      max-width: 800px;
      margin: 30px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    form h2 {
      margin-bottom: 20px;
      font-size: 1.5rem;
      color: #D21F26;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    button {
      background-color: #D21F26;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #b7181e;
    }

    /* Seat Map */
    .bus {
      margin-top: 30px;
    }

    .seat-map {
  display: grid;
  
  justify-content: center;
  margin-top: 20px;
}

.seat {
  width: 60px;
  height: 60px;
  background-color: #ddd;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background-size: cover; /* Ajustar el tamaño de la imagen */
  background-position: center; /* Centrar la imagen */
  color:white;

}

.seat.occupied {
  background-color: red;
  pointer-events: none;
}

.seat.selected {
  background-color: 	#87CEFA;
  color: white;
}



    .seat img {
      width: 100%;
    }

    /* Payment and Extras */
    .extras {
      margin-top: 30px;
    }

    .extras li {
      margin-bottom: 10px;
    }

    .extras p {
      font-size: 0.9rem;
      color: #666;
    }

    /* Footer */
    footer {
      margin-top: 30px;
      padding: 10px;
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      border-top: 1px solid #ddd;
    }
/* Modal general */
#ticket-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

/* Estilo del ticket */
.modal-ticket {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 350px;
  font-family: "Courier New", monospace;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
  position: relative;
}

.modal-ticket h1 {
  font-size: 24px;
  margin-bottom: 5px;
  color: #D21F26;
}

.modal-ticket p {
  margin: 5px 0;
}

.modal-ticket .ticket-details {
  margin-top: 10px;
  text-align: left;
  font-size: 14px;
}

.modal-ticket ul {
  padding: 0;
  list-style: none;
}

.modal-ticket ul li {
  background: #f9f9f9;
  padding: 5px;
  margin: 5px 0;
  border-radius: 3px;
}

.modal-ticket button {
  margin-top: 10px;
  padding: 10px;
  width: 100%;
  border: none;
  background: #D21F26;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

.modal-ticket button:hover {
  background: #b7181e;
}
/* Estilos del Modal de Términos y Condiciones */
.modal-terminosCondiciones {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-terminosCondiciones-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-terminosCondiciones-title {
  margin-bottom: 15px;
  color: #D21F26;
}

.modal-terminosCondiciones-text {
  margin-bottom: 20px;
}

.modal-terminosCondiciones-closeButton {
  background-color: #D21F26;
  color: #fff;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.modal-terminosCondiciones-closeButton:hover {
  background-color: #b7181e;
}

 
  </style>
</head>
<body>
  <div class="header">
    <img src="../ADO-Autobuses-de-Oriente-Logo-700x394.png" alt="ADO Logo">
    <div class="nav-links">
      <a href="../usuario/inicio.html">Inicio</a>
  
      <!-- Menú desplegable para Boletos -->
      <div class="dropdown">
        <a href="#" class="dropbtn" style="background-color: #f79191" ;>Boletos</a>
        <div class="dropdown-content">
          <a href="../sesion/compra de boleto.html">Comprar boleto</a>
          
        </div>
      </div>
  
      <!-- Enlace simple para Perfil -->
      <a href="../usuario/corridas.html">Corridas</a> <a href="../usuario/perfil.html">Perfil</a>
  
     
      <a href="../index.html"  id="logoutButton" name="logoutButton" class="logout-button">Cerrar Sesión</a>
  </div>  </div>
  

  
  <!-- Formulario de Compra -->
  <form>
    <h2>Compra tu boleto</h2>

    <div id="corrida-details" style="margin-bottom: 20px;">
      <!-- La información se generará aquí dinámicamente -->
    </div>

    <!-- Mapa de Asientos -->
    <div class="bus">
      <h2>Selecciona tu asiento</h2>
      <div id="seat-map" class="seat-map"></div>


    </div>
    

    <!-- Pago -->
    <h3>Detalles de pago</h3>
    <p>Total: <span id="total">$0.00</span></p>
    <label>
      <input type="checkbox" id="terminos"> Acepto los términos y condiciones
    </label>
    <button type="submit">Comprar</button>
  </form>
<!-- Modal de Ticket -->
<div id="ticket-modal" style="display: none;">
  <div class="modal-ticket">
    <h1>ADO</h1>
    <p><strong>Boleto de Autobús</strong></p>
    <div class="ticket-details">
      <p><strong>Número de Boleto:</strong> <span id="ticket-number"></span></p>
      <p><strong>Fecha de Compra:</strong> <span id="purchase-date"></span></p>
      <p><strong>Asientos:</strong></p>
      <ul id="seat-list"></ul>
      <p><strong>Total:</strong> <span id="ticket-amount"></span></p>
    </div>
    <button id="download-ticket">Guardar Ticket</button>
    <button id="close-ticket">Cerrar</button>
  </div>
</div>
<!-- Modal de Advertencia para Términos y Condiciones -->
<div id="modal-terminosCondiciones" class="modal-terminosCondiciones" style="display: none;">
  <div class="modal-terminosCondiciones-content">
    <h2 class="modal-terminosCondiciones-title">Atención</h2>
    <p class="modal-terminosCondiciones-text">Debe aceptar los términos y condiciones para continuar con la compra.</p>
    <button id="btn-cerrar-modal-terminosCondiciones" class="modal-terminosCondiciones-closeButton">Cerrar</button>
  </div>
</div>


  <!-- Footer -->
  <footer>
    © 2024 ADO - Todos los derechos reservados.
  </footer>

  <!-- Script para Selección de Asientos -->
  <script>
    const token = localStorage.getItem('token');
    const idCorrida = localStorage.getItem('idCorrida'); // Cambiar por el ID dinámico necesario
      // Función para obtener detalles de la corrida
      function getCorridaDetalles(idCorrida) {

          if (!token) {
              console.error("No hay token disponible, por favor inicia sesión primero.");
              alert("Por favor, inicia sesión para continuar.");
              return;
          }

          console.log("Token:", token);

          const apiUrl = "http://127.0.0.1:8000"; // URL base de la API
          fetch(apiUrl + "/api/corrida/detalles", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({
                  token: token,
                  id: idCorrida
              }),
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error("Error en la solicitud: " + response.status);
              }
              return response.json();
          })
          .then(data => {
              if (data.corrida && data.corrida.asientos) {
                  const precio = parseFloat(data.corrida.precio);
                  console.log("Detalles de la corrida:", data.corrida);
                  renderSeatMap(data.corrida.asientos); // Renderizar mapa de asientos
                  attachSelectionEvents(precio);       // Configurar eventos de selección
              } else {
                  console.error("Error al obtener los detalles de la corrida:", data.message || "Respuesta inesperada.");
                  alert("No se pudo obtener la información de la corrida.");
              }
          })
          .catch(error => {
              console.error("Error al realizar la solicitud:", error);
              alert("Ocurrió un error inesperado. Intenta nuevamente más tarde.");
          });
      }

      function formatHour(hour) {
    // Verifica que la hora esté en un formato válido
        if (hour && hour.includes(":")) {
            // Divide la hora en sus componentes
            const [hours, minutes] = hour.split(":").map(part => parseInt(part, 10));
            if (!isNaN(hours) && !isNaN(minutes)) {
              // Determina si es AM o PM
              const period = hours >= 12 ? "PM" : "AM";
              // Convierte las horas al formato de 12 horas
              const adjustedHours = hours % 12 || 12; // Convierte "0" o "12" a "12" en formato 12 horas
              return `${adjustedHours}:${minutes.toString().padStart(2, "0")} ${period}`;
            }
          }
          return hour; // Devuelve el valor original si no cumple el formato esperado
}

function renderCorridaDetails(corrida) {
  const corridaDetailsContainer = document.getElementById("corrida-details");

  corridaDetailsContainer.innerHTML = `
    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
      <h3>Detalles de la Corrida</h3>
      <p><strong>Origen:</strong> ${corrida.origen}</p>
      <p><strong>Destino:</strong> ${corrida.destino}</p>
      <p><strong>Fecha:</strong> ${corrida.fecha}</p>
      <p><strong>Hora de salida:</strong> ${formatHour(corrida.hora_salida)}</p>
      <p><strong>Hora estimada de llegada:</strong> ${formatHour(corrida.hora_estima_llegada)}</p>
      <p><strong>Precio:</strong> $${corrida.precio}</p>
      <p><strong>Tipo de Corrida:</strong> ${corrida.tipo_corrida === "1" ? "Directa" : "Con Escalas"}</p>
    </div>
  `;
}

// Modifica la función para llamar a renderCorridaDetails
function getCorridaDetalles(idCorrida) {
  if (!token) {
    console.error("No hay token disponible, por favor inicia sesión primero.");
    alert("Por favor, inicia sesión para continuar.");
    return;
  }

  console.log("Token:", token);

  const apiUrl = "http://127.0.0.1:8000"; // URL base de la API
  fetch(apiUrl + "/api/corrida/detalles", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      token: token,
      id: idCorrida
    }),
  })
  .then(response => {
    if (!response.ok) {
      throw new Error("Error en la solicitud: " + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.corrida) {
      console.log("Detalles de la corrida:", data.corrida);
      renderCorridaDetails(data.corrida); // Renderizar los detalles de la corrida
      renderSeatMap(data.corrida.asientos); // Renderizar mapa de asientos
      attachSelectionEvents(parseFloat(data.corrida.precio)); // Configurar eventos de selección
    } else {
      console.error("Error al obtener los detalles de la corrida:", data.message || "Respuesta inesperada.");
      alert("No se pudo obtener la información de la corrida.");
    }
  })
  .catch(error => {
    console.error("Error al realizar la solicitud:", error);
    alert("Ocurrió un error inesperado. Intenta nuevamente más tarde.");
  });
}


      // Renderizar mapa de asientos
      function renderSeatMap(asientos) {
          const seatMapContainer = document.getElementById("seat-map");
          seatMapContainer.innerHTML = ""; // Limpiar el mapa previo

          const numRows = Math.ceil(asientos.length / 4); // Calcular filas necesarias
          let index = 0;

          for (let i = 0; i < numRows; i++) {
              const rowDiv = document.createElement("div");
              rowDiv.style.display = "flex";
              rowDiv.style.justifyContent = "center";
              rowDiv.style.marginBottom = "10px";

              // Crear dos asientos lado izquierdo
              for (let j = 0; j < 2; j++) {
                  if (index < asientos.length) {
                      const seat = createSeatElement(asientos[index]);
                      rowDiv.appendChild(seat);
                      index++;
                  }
              }

              // Espacio para el pasillo
              const aisleSpace = document.createElement("div");
              aisleSpace.style.width = "20px";
              rowDiv.appendChild(aisleSpace);

              // Crear dos asientos lado derecho
              for (let j = 0; j < 2; j++) {
                  if (index < asientos.length) {
                      const seat = createSeatElement(asientos[index]);
                      rowDiv.appendChild(seat);
                      index++;
                  }
              }

              seatMapContainer.appendChild(rowDiv);
          }
      }

      // Crear un asiento dinámico
      function createSeatElement(asiento) {
          const seatDiv = document.createElement("div");
          seatDiv.classList.add("seat");
          seatDiv.dataset.seat = asiento.numero;
          seatDiv.dataset.estado = asiento.estado;
          seatDiv.style.backgroundImage = "url('../../recursos/img/SolarChairBoldDuotone.svg')"; // Imagen para asientos disponibles

          if (asiento.estado === "ocupado") {
              seatDiv.classList.add("occupied");
          }

          seatDiv.textContent = asiento.numero;
          return seatDiv;
      }

      // Configurar eventos de selección
      function attachSelectionEvents(precio) {
          const seats = document.querySelectorAll(".seat:not(.occupied)");
          const totalDisplay = document.getElementById("total");
          let selectedSeats = [];

          seats.forEach(seat => {
              seat.addEventListener("click", () => {
                  const seatNumber = seat.dataset.seat;

                  if (seat.classList.contains("selected")) {
                      // Deseleccionar asiento
                      seat.classList.remove("selected");
                      selectedSeats = selectedSeats.filter(num => num !== seatNumber);
                  } else {
                      // Validar que no se seleccione más de una vez
                      if (!selectedSeats.includes(seatNumber)) {
                          seat.classList.add("selected");
                          selectedSeats.push(seatNumber);
                      }
                  }

                  // Actualizar el total
                  const total = selectedSeats.length * precio;
                  totalDisplay.textContent = `$${total.toFixed(2)}`;

                  console.log("Asientos seleccionados:", selectedSeats);
              });
          });
      }

      function mostrarTicketModal(boleto, asientos) {
    const modal = document.getElementById("ticket-modal");
    const ticketNumber = document.getElementById("ticket-number");
    const purchaseDate = document.getElementById("purchase-date");
    const seatList = document.getElementById("seat-list");
    const ticketAmount = document.getElementById("ticket-amount");

    // Asignar datos del boleto
    ticketNumber.textContent = boleto.num_boleto;
    purchaseDate.textContent = new Date(boleto.fecha_compra).toLocaleString();
    ticketAmount.textContent = `$${boleto.monto}`;

    // Asientos comprados
    seatList.innerHTML = ""; // Limpiar lista previa
    asientos.forEach(asiento => {
        const li = document.createElement("li");
        li.textContent = `Asiento ${asiento}`;
        seatList.appendChild(li);
    });

    // Mostrar el modal
    modal.style.display = "flex";

    // Configurar botón para cerrar
    document.getElementById("close-ticket").onclick = () => {
        modal.style.display = "none";
    };

    document.getElementById("download-ticket").onclick = () => {
    const modal = document.querySelector(".modal-ticket");
    const downloadButton = document.getElementById("download-ticket");
    const closeButton = document.getElementById("close-ticket");

    // Ocultar los botones antes de capturar la imagen
    downloadButton.style.display = "none";
    closeButton.style.display = "none";

    // Capturar la imagen del ticket
    html2canvas(modal).then(canvas => {
        // Restaurar la visibilidad de los botones después de capturar la imagen
        downloadButton.style.display = "block";
        closeButton.style.display = "block";

        // Crear un enlace para descargar la imagen
        const link = document.createElement("a");
        link.download = `ticket_${document.getElementById("ticket-number").textContent}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }).catch(error => {
        console.error("Error al guardar el ticket:", error);

        // Asegurarse de restaurar los botones en caso de error
        downloadButton.style.display = "block";
        closeButton.style.display = "block";
    });
};

}

// Uso en la compra de boletos
function comprarBoleto(token, idCorrida, asientosSeleccionados) {
    const apiUrl = "http://127.0.0.1:8000";

    if (!token) {
        alert("Por favor, inicia sesión para continuar.");
        return;
    }

    if (asientosSeleccionados.length === 0) {
        alert("Por favor, selecciona al menos un asiento.");
        return;
    }

    fetch(apiUrl + "/api/comprar-boleto", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            token: token,
            id_corrida: idCorrida,
            asientos: asientosSeleccionados.map(Number)
        }),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Error en la solicitud: " + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.message === "Boleto comprado con éxito") {
            mostrarTicketModal(data.boleto, asientosSeleccionados); // Mostrar ticket
        } else {
            alert(data.message || "Ocurrió un error inesperado.");
        }
    })
    .catch(error => {
        console.error("Error al realizar la solicitud:", error);
        alert("Ocurrió un error inesperado. Intenta nuevamente más tarde.");
    });
}


// Función para mostrar el modal de términos y condiciones
function mostrarModalTerminosCondiciones() {
  const modal = document.getElementById("modal-terminosCondiciones");
  modal.style.display = "flex"; // Mostrar el modal
}

// Función para cerrar el modal de términos y condiciones
function cerrarModalTerminosCondiciones() {
  const modal = document.getElementById("modal-terminosCondiciones");
  modal.style.display = "none"; // Ocultar el modal
}

// Añadir el evento al botón de cerrar
document
  .getElementById("btn-cerrar-modal-terminosCondiciones")
  .addEventListener("click", cerrarModalTerminosCondiciones);

// Escuchar evento de compra
document.querySelector("form").addEventListener("submit", event => {
  event.preventDefault(); // Evitar envío por defecto del formulario

  //const token = "2|s66QqsWfjZvgNuPnNNIG8454A1AEMWRRXWwEqpKA57ac6b93"; // Cambiar por el token del usuario autenticado
  //const idCorrida = 1; // Cambiar por el ID dinámico necesario
  const selectedSeats = [...document.querySelectorAll(".seat.selected")].map(
    seat => seat.dataset.seat
  );
  const terminosAceptados = document.getElementById("terminos").checked;

  if (!terminosAceptados) {
    mostrarModalTerminosCondiciones(); // Mostrar el modal si no aceptó los términos
    return;
  }

  comprarBoleto(token, idCorrida, selectedSeats); // Proceder con la compra si aceptó
});

// Configurar recarga automática del render cada 10 segundos
function startAutoReload(idCorrida) {
    setInterval(() => {
        console.log("Recargando mapa de asientos...");
        getCorridaDetalles(idCorrida); // Actualizar dinámicamente el mapa de asientos
    }, 10000); // Intervalo de 10 segundos
}

// Llamada inicial y activación del ciclo de recarga
//const idCorrida = localStorage.getItem('id'); // Cambiar por el ID dinámico necesario
getCorridaDetalles(idCorrida); // Cargar los detalles inicialmente
startAutoReload(idCorrida);    // Activar la recarga automática

  </script>
</body>
</html>
